<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой прогресс</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>Мой прогресс</header>

    <nav>
        <button onclick="window.location.href='index.html'">На главную</button>
        <button onclick="loadProgress()">Обновить</button>
    </nav>

    <main>
        <div>
            <h3>Статистика</h3>
            <div>
                <strong>Тренажер:</strong>
                <div>Пройдено: <span id="completed">0</span> вопросов</div>
                <div>Правильно: <span id="correct">0</span></div>
                <div>Точность: <span id="accuracy">0%</span></div>
            </div>
            
            <div>
                <strong>Экзамены:</strong>
                <div>Попыток: <span id="attempts">0</span></div>
                <div>Сдано: <span id="passed">0</span></div>
            </div>
        </div>

        <div>
            <h3>Прогресс по блокам</h3>
            <div id="blocks">
                <!-- Блоки будут тут -->
            </div>
        </div>
    </main>

    <script src="api.js"></script>
    <script src="data-loader.js"></script>
    <script>
        // Простая функция загрузки прогресса
        async function loadProgress() {
            console.log('Загрузка прогресса...');
            
            const user = examAPI.getUserFromStorage();
            if (!user) {
                alert('Войдите в систему');
                return;
            }
            
            // Ждем загрузки вопросов
            if (!window.questionsData) {
                console.log('Жду загрузки вопросов...');
                setTimeout(loadProgress, 500);
                return;
            }
            
            // Загружаем прогресс тренажера
            const storageKey = user.userType === 'guest' 
                ? 'trainerProgress_guest' 
                : `trainerProgress_${user.id}`;
            
            const saved = localStorage.getItem(storageKey);
            const allProgress = saved ? JSON.parse(saved) : {};
            
            let totalCompleted = 0;
            let totalCorrect = 0;
            let totalQuestions = 0;
            
            const blocks = ['Блок 1', 'Блок 2', 'Блок 3', 'Блок 4'];
            let html = '';
            
            for (const block of blocks) {
                const progress = allProgress[block];
                const blockQuestions = window.questionsData[block] || [];
                
                if (progress && progress.userAnswers) {
                    const answered = progress.answered || 0;
                    const total = blockQuestions.length;
                    const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
                    
                    // Считаем правильные
                    let correct = 0;
                    progress.userAnswers.forEach((answer, index) => {
                        if (answer !== null && blockQuestions[index]) {
                            const question = blockQuestions[index];
                            const correctAnswer = question.correctAnswers || [];
                            if (JSON.stringify(answer.sort()) === JSON.stringify(correctAnswer.sort())) {
                                correct++;
                            }
                        }
                    });
                    
                    totalCompleted += answered;
                    totalQuestions += total;
                    totalCorrect += correct;
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                            <strong>${block}</strong>
                            <div>${answered}/${total} вопросов (${percent}%)</div>
                            <div>Правильно: ${correct}/${answered} (${answered > 0 ? Math.round(correct/answered*100) : 0}%)</div>
                            <button onclick="startTraining('${block}')">Продолжить</button>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                            <strong>${block}</strong>
                            <div>Не начат</div>
                            <button onclick="startTraining('${block}')">Начать</button>
                        </div>
                    `;
                }
            }
            
            document.getElementById('blocks').innerHTML = html;
            
            // Обновляем статистику
            document.getElementById('completed').textContent = totalCompleted;
            document.getElementById('correct').textContent = totalCorrect;
            document.getElementById('accuracy').textContent = totalCompleted > 0 ? 
                Math.round((totalCorrect / totalCompleted) * 100) + '%' : '0%';
            
            // Загружаем историю экзаменов
            const result = await examAPI.getExamAttempts();
            if (result.success) {
                const attempts = result.attempts || [];
                const passed = attempts.filter(a => a.isPassed).length;
                
                document.getElementById('attempts').textContent = attempts.length;
                document.getElementById('passed').textContent = passed;
            }
        }
        
        function startTraining(block) {
            localStorage.setItem('selectedBlock', block);
            window.location.href = 'trainer.html';
        }
        
        // Автозагрузка при открытии
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadProgress, 1000);
        });
    </script>
</body>
</html>